<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="main">

    <select id="getMainEntHistList" parameterType="aero.cubox.core.vo.EntHistVO" resultType="aero.cubox.core.vo.EntHistVO">
        select
        eh.id,
        date_format(eh.evt_dt, '%m-%d %H:%i:%S') as evtDtStr,
        door_nm as doorNm,
        emp_nm as empNm,
        c3.cd_nm as  cardStateTypNm,
        c1.cd_nm as  entEvtTypNm
        from T_ENT_HIST eh
        left outer join T_TERMINAL tm on eh.terminal_cd = tm.terminal_cd
        LEFT OUTER JOIN T_CMMN_CD c1 on c1.cd = eh.ent_evt_typ and c1.cd_typ = 'EntEvtTyp'
        LEFT OUTER JOIN T_CMMN_CD c3 on c3.cd = eh.card_state_typ and c3.cd_typ = 'CardStateTyp'
        ORDER BY eh.created_at DESC
        limit	8
    </select>

    <select id="getDayEntCount" resultType="int">
        select count(*) FROM T_ENT_HIST where DATE(created_at)=Date(now())
    </select>

    <select id="getDayEntEmpCount" resultType="int">
        select count(*) FROM
                (select emp_cd FROM T_ENT_HIST where emp_cd != ""  and DATE(created_at)=Date(now()) group by emp_cd) A
    </select>


    <select id="selectMainAlarmHistList" parameterType="hashmap" resultType="hashmap">
         SELECT dh.id
              , DATE_FORMAT(dh.evt_dt, '%m-%d %H:%i:%S') as evtDtStr
              , c1.cd_nm as doorAlarmTypNm
              , IFNULL(dh.building_nm, '') as buildingNm
              , IFNULL(door_nm, '') as doorNm
           FROM T_DOORALARM_HIST dh
LEFT OUTER JOIN T_TERMINAL tm on dh.terminal_cd = tm.terminal_cd
LEFT OUTER JOIN T_CMMN_CD c1 on c1.cd = dh.door_alarm_typ and c1.cd_typ = 'DoorAlarmTyp'
       ORDER BY dh.created_at DESC
          LIMIT	8
    </select>

    <select id="selectMainStatus01" parameterType="hashmap" resultType="hashmap">
        SELECT DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -15 DAY), '%m-%d') AS EXP_DAY
             , IFNULL(CF_TOT, 0) AS TOT_LOG_CNT
             , IFNULL(CF_PASS, 0) AS SUCCESS_LOG_CNT
             , IFNULL(CF_FAIL, 0) AS FAIL_LOG_CNT
          FROM (SELECT DATE_FORMAT(EVT_DT,'%m-%d') FEVTTM
                   , COUNT(EVT_DT) AS CF_TOT
                   , SUM(CASE WHEN ENT_EVT_TYP IN ('EET000') THEN 1 ELSE 0 END) AS CF_PASS
                   , SUM(CASE WHEN ENT_EVT_TYP  IN ('EET000') THEN 0 ELSE 1 END) AS CF_FAIL
                FROM T_ENT_HIST
               WHERE EVT_DT BETWEEN DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -15 DAY), '%y-%m-%d')
                        AND CONCAT(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -15 DAY), '%y-%m-%d'), ' 23:59:59.999')
             ) D5
     UNION ALL
        SELECT DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -14 DAY), '%m-%d') AS EXP_DAY
             , IFNULL(CF_TOT, 0) AS TOT_LOG_CNT
             , IFNULL(CF_PASS, 0) AS SUCCESS_LOG_CNT
             , IFNULL(CF_FAIL, 0) AS FAIL_LOG_CNT
          FROM (SELECT DATE_FORMAT(EVT_DT,'%m-%d') FEVTTM
                    , COUNT(EVT_DT) AS CF_TOT
                    , SUM(CASE WHEN ENT_EVT_TYP IN ('EET000') THEN 1 ELSE 0 END) AS CF_PASS
                    , SUM(CASE WHEN ENT_EVT_TYP  IN ('EET000') THEN 0 ELSE 1 END) AS CF_FAIL
                 FROM T_ENT_HIST
                WHERE EVT_DT BETWEEN DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -14 DAY), '%y-%m-%d')
                        AND CONCAT(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -14 DAY), '%y-%m-%d'), ' 23:59:59.999')
             ) D4
     UNION ALL
        SELECT DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -13 DAY), '%m-%d') AS EXP_DAY
             , IFNULL(CF_TOT, 0) AS TOT_LOG_CNT
             , IFNULL(CF_PASS, 0) AS SUCCESS_LOG_CNT
             , IFNULL(CF_FAIL, 0) AS FAIL_LOG_CNT
          FROM (SELECT DATE_FORMAT(EVT_DT,'%m-%d') FEVTTM
                     , COUNT(EVT_DT) AS CF_TOT
                     , SUM(CASE WHEN ENT_EVT_TYP IN ('EET000') THEN 1 ELSE 0 END) AS CF_PASS
                     , SUM(CASE WHEN ENT_EVT_TYP  IN ('EET000') THEN 0 ELSE 1 END) AS CF_FAIL
                  FROM T_ENT_HIST
                 WHERE EVT_DT BETWEEN DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -13 DAY), '%y-%m-%d')
                   AND CONCAT(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -13 DAY), '%y-%m-%d'), ' 23:59:59.999')
             ) D3
     UNION ALL
        SELECT DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -12 DAY), '%m-%d') AS EXP_DAY
             , IFNULL(CF_TOT, 0) AS TOT_LOG_CNT
             , IFNULL(CF_PASS, 0) AS SUCCESS_LOG_CNT
             , IFNULL(CF_FAIL, 0) AS FAIL_LOG_CNT
          FROM (SELECT DATE_FORMAT(EVT_DT,'%m-%d') FEVTTM
                   , COUNT(EVT_DT) AS CF_TOT
                   , SUM(CASE WHEN ENT_EVT_TYP IN ('EET000') THEN 1 ELSE 0 END) AS CF_PASS
                   , SUM(CASE WHEN ENT_EVT_TYP  IN ('EET000') THEN 0 ELSE 1 END) AS CF_FAIL
                FROM T_ENT_HIST
               WHERE EVT_DT BETWEEN DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -12 DAY), '%y-%m-%d')
                 AND CONCAT(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -12 DAY), '%y-%m-%d'), ' 23:59:59.999')
             ) D2
     UNION ALL
        SELECT DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -11 DAY), '%m-%d') AS EXP_DAY
             , IFNULL(CF_TOT, 0) AS TOT_LOG_CNT
             , IFNULL(CF_PASS, 0) AS SUCCESS_LOG_CNT
             , IFNULL(CF_FAIL, 0) AS FAIL_LOG_CNT
          FROM (SELECT DATE_FORMAT(EVT_DT,'%m-%d') FEVTTM
                    , COUNT(EVT_DT) AS CF_TOT
                    , SUM(CASE WHEN ENT_EVT_TYP IN ('EET000') THEN 1 ELSE 0 END) AS CF_PASS
                    , SUM(CASE WHEN ENT_EVT_TYP  IN ('EET000') THEN 0 ELSE 1 END) AS CF_FAIL
                 FROM T_ENT_HIST
                WHERE EVT_DT BETWEEN DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -11 DAY), '%Y-%m-%d')
                  AND CONCAT(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -11 DAY), '%Y-%m-%d'), ' 23:59:59.999')
             ) D

    </select>

</mapper>